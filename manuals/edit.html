<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手順書編集 - 手順書管理システム</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>手順書管理システム</h1>
            <nav>
                <a href="../index.html">手順書一覧</a>
                <span id="userName"></span>
                <button id="logoutBtn">ログアウト</button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <h1 class="card-title">手順書編集</h1>
            
            <div id="loadingMessage" class="loading">読み込み中</div>
            
            <form id="manualForm" style="display: none;">
                <div class="form-group">
                    <label for="title">タイトル <span style="color: red;">*</span></label>
                    <input type="text" id="title" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="description">説明</label>
                    <textarea id="description" name="description" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="visibility">公開範囲</label>
                    <select id="visibility" name="visibility">
                        <option value="public">全体公開</option>
                        <option value="department">部署内公開</option>
                        <option value="private">非公開</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tags">タグ（カンマ区切り）</label>
                    <input type="text" id="tags" name="tags" placeholder="例: 作業手順, 初心者向け">
                </div>
                
                <div class="form-group">
                    <label>ステップ</label>
                    <div id="stepsContainer"></div>
                    <button type="button" class="btn btn-secondary" id="addStepBtn">ステップを追加</button>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" name="action" value="draft" class="btn btn-secondary">下書き保存</button>
                    <button type="submit" name="action" value="publish" class="btn btn-success">公開</button>
                    <a href="../index.html" class="btn">キャンセル</a>
                </div>
            </form>
        </div>
    </div>
    
    <script src="../static/js/api.js"></script>
    <script>
        let currentUser = null;
        let manualId = null;
        let stepCounter = 0;
        
        // 初期化
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            
            // URLパラメータから手順書IDを取得
            const params = new URLSearchParams(window.location.search);
            manualId = params.get('id');
            
            if (!manualId) {
                showAlert('手順書IDが指定されていません', 'error');
                return;
            }
            
            await loadManual();
        }
        
        // 手順書を読み込み
        async function loadManual() {
            try {
                const data = await ManualAPI.get(manualId);
                const manual = data.manual;
                
                // 編集権限チェック
                if (manual.author_id !== currentUser.id && currentUser.role !== 'admin') {
                    showAlert('編集権限がありません', 'error');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 2000);
                    return;
                }
                
                // フォームに値を設定
                document.getElementById('title').value = manual.title;
                document.getElementById('description').value = manual.description || '';
                document.getElementById('visibility').value = manual.visibility;
                
                // タグを設定
                if (manual.tags && manual.tags.length > 0) {
                    document.getElementById('tags').value = manual.tags.map(t => t.name).join(', ');
                }
                
                // ステップを追加
                if (manual.steps && manual.steps.length > 0) {
                    manual.steps.forEach(step => {
                        addStep(step);
                    });
                } else {
                    addStep();
                }
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('manualForm').style.display = 'block';
                
            } catch (error) {
                handleError(error);
            }
        }
        
        // ステップを追加
        function addStep(stepData = null) {
            stepCounter++;
            const container = document.getElementById('stepsContainer');
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-item';
            stepDiv.id = `step-${stepCounter}`;
            stepDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3>ステップ ${stepCounter}</h3>
                    <button type="button" class="btn btn-danger" onclick="removeStep('step-${stepCounter}')" style="padding: 0.25rem 0.75rem;">削除</button>
                </div>
                
                <div class="form-group">
                    <label>タイトル</label>
                    <input type="text" class="step-title" placeholder="ステップのタイトル" value="${stepData ? escapeHtml(stepData.title) : ''}">
                </div>
                
                <div class="form-group">
                    <label>内容</label>
                    <textarea class="step-content" rows="3" placeholder="手順の詳細">${stepData ? escapeHtml(stepData.content) : ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>備考</label>
                    <textarea class="step-note" rows="2" placeholder="注意事項など">${stepData ? escapeHtml(stepData.note) : ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>画像</label>
                    ${stepData && stepData.image_path ? `<div><img src="${stepData.image_path}" style="max-width: 300px; margin-bottom: 0.5rem; border-radius: 4px;"></div>` : ''}
                    <input type="file" class="step-image" accept="image/*">
                    <input type="hidden" class="step-existing-image" value="${stepData && stepData.image_path ? stepData.image_path : ''}">
                    <div class="step-image-preview" style="margin-top: 0.5rem;"></div>
                </div>
            `;
            
            container.appendChild(stepDiv);
            
            // 画像アップロードのプレビュー
            const imageInput = stepDiv.querySelector('.step-image');
            const imagePreview = stepDiv.querySelector('.step-image-preview');
            
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = `<img src="${e.target.result}" style="max-width: 300px; border-radius: 4px;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // ステップを削除
        function removeStep(stepId) {
            const stepDiv = document.getElementById(stepId);
            if (stepDiv) {
                stepDiv.remove();
            }
        }
        
        // フォーム送信
        document.getElementById('manualForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitter = e.submitter;
            const action = submitter.value;
            
            try {
                // 基本情報を取得
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const visibility = document.getElementById('visibility').value;
                const tagsInput = document.getElementById('tags').value;
                
                // タグを配列に変換
                const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                
                // ステップを取得
                const steps = [];
                const stepDivs = document.querySelectorAll('[id^="step-"]');
                
                for (const stepDiv of stepDivs) {
                    const stepTitle = stepDiv.querySelector('.step-title').value;
                    const stepContent = stepDiv.querySelector('.step-content').value;
                    const stepNote = stepDiv.querySelector('.step-note').value;
                    const stepImageInput = stepDiv.querySelector('.step-image');
                    const existingImage = stepDiv.querySelector('.step-existing-image').value;
                    
                    let imagePath = existingImage;
                    
                    // 新しい画像がある場合はアップロード
                    if (stepImageInput.files.length > 0) {
                        const imageData = await ManualAPI.uploadImage(stepImageInput.files[0]);
                        imagePath = imageData.path;
                    }
                    
                    steps.push({
                        title: stepTitle || `ステップ ${steps.length + 1}`,
                        content: stepContent,
                        note: stepNote,
                        image_path: imagePath
                    });
                }
                
                // 手順書データ
                const manualData = {
                    title: title,
                    description: description,
                    visibility: visibility,
                    is_published: action === 'publish' ? 1 : 0,
                    tags: tags,
                    steps: steps
                };
                
                // API呼び出し
                await ManualAPI.update(manualId, manualData);
                
                showAlert('手順書を更新しました', 'success');
                
                setTimeout(() => {
                    window.location.href = `../manuals/view.html?id=${manualId}`;
                }, 1000);
                
            } catch (error) {
                handleError(error);
            }
        });
        
        // ユーティリティ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // イベントリスナー
        document.getElementById('addStepBtn').addEventListener('click', () => addStep());
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await AuthAPI.logout();
                window.location.href = '../login.html';
            } catch (error) {
                handleError(error);
            }
        });
        
        // 初期化実行
        init();
    </script>
</body>
</html>
