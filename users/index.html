<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー管理 - 手順書管理システム</title>
    <link rel="stylesheet" href="/manual_factory/static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>手順書管理システム</h1>
            <nav>
                <a href="/manual_factory/index.html">手順書一覧</a>
                <a href="/manual_factory/users/index.html">ユーザー管理</a>
                <span id="userName"></span>
                <button id="logoutBtn">ログアウト</button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 class="card-title" style="margin: 0;">ユーザー管理</h2>
                <button class="btn btn-success" id="createUserBtn">新規ユーザー</button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="検索...">
                <button class="btn btn-primary" id="searchBtn">検索</button>
            </div>
            
            <div id="usersContainer">
                <div class="loading">読み込み中</div>
            </div>
            
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
    
    <!-- ユーザー作成/編集モーダル -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ユーザー作成</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="name">氏名 <span style="color: red;">*</span></label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="email">メールアドレス <span style="color: red;">*</span></label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group" id="passwordGroup">
                    <label for="password">パスワード <span style="color: red;">*</span></label>
                    <input type="password" id="password" minlength="6">
                    <small style="color: #666;">6文字以上で入力してください</small>
                </div>
                
                <div class="form-group">
                    <label for="department">所属</label>
                    <input type="text" id="department">
                </div>
                
                <div class="form-group">
                    <label for="role">権限</label>
                    <select id="role">
                        <option value="user">一般ユーザー</option>
                        <option value="admin">管理者</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-success">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/manual_factory/static/js/api.js"></script>
    <script>
        let currentUser = null;
        let currentPage = 1;
        const limit = 20;
        let isEditMode = false;
        
        // 初期化
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            
            // 管理者権限チェック
            if (currentUser.role !== 'admin') {
                showAlert('管理者権限が必要です', 'error');
                setTimeout(() => {
                    window.location.href = '/manual_factory/index.html';
                }, 2000);
                return;
            }
            
            document.getElementById('userName').textContent = currentUser.name;
            loadUsers();
        }
        
        // ユーザー一覧を読み込み
        async function loadUsers() {
            try {
                const search = document.getElementById('searchInput').value;
                
                const params = {
                    page: currentPage,
                    limit: limit,
                    search: search
                };
                
                const data = await UserAPI.list(params);
                
                displayUsers(data.users);
                displayPagination(data.pagination);
            } catch (error) {
                handleError(error);
            }
        }
        
        // ユーザーを表示
        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ユーザーが見つかりません</p>';
                return;
            }
            
            let html = '<table><thead><tr>';
            html += '<th>氏名</th>';
            html += '<th>メールアドレス</th>';
            html += '<th>所属</th>';
            html += '<th>権限</th>';
            html += '<th>登録日</th>';
            html += '<th>操作</th>';
            html += '</tr></thead><tbody>';
            
            users.forEach(user => {
                html += '<tr>';
                html += `<td>${escapeHtml(user.name)}</td>`;
                html += `<td>${escapeHtml(user.email)}</td>`;
                html += `<td>${escapeHtml(user.department || '-')}</td>`;
                html += `<td>${user.role === 'admin' ? '<span class="badge badge-danger">管理者</span>' : '<span class="badge badge-info">一般</span>'}</td>`;
                html += `<td>${formatDate(user.created_at)}</td>`;
                html += '<td>';
                html += `<button onclick="editUser(${user.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">編集</button>`;
                
                // 自分自身は削除できない
                if (user.id !== currentUser.id) {
                    html += `<button onclick="deleteUser(${user.id})" class="btn btn-danger" style="padding: 0.5rem 1rem;">削除</button>`;
                }
                
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ページネーション表示
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">前へ</button>`;
            
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }
            
            html += `<button ${currentPage === pagination.pages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">次へ</button>`;
            
            container.innerHTML = html;
        }
        
        // ページ変更
        function changePage(page) {
            currentPage = page;
            loadUsers();
        }
        
        // モーダルを開く（新規作成）
        document.getElementById('createUserBtn').addEventListener('click', () => {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'ユーザー作成';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('userModal').classList.add('active');
        });
        
        // モーダルを開く（編集）
        async function editUser(userId) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'ユーザー編集';
            document.getElementById('userId').value = userId;
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('password').required = false;
            document.getElementById('password').placeholder = '変更する場合のみ入力';
            
            try {
                // ユーザー情報を取得（一覧から取得）
                const data = await UserAPI.list({ search: '' });
                const user = data.users.find(u => u.id === userId);
                
                if (user) {
                    document.getElementById('name').value = user.name;
                    document.getElementById('email').value = user.email;
                    document.getElementById('department').value = user.department || '';
                    document.getElementById('role').value = user.role;
                }
                
                document.getElementById('userModal').classList.add('active');
            } catch (error) {
                handleError(error);
            }
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
        }
        
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        
        // モーダル外クリックで閉じる
        document.getElementById('userModal').addEventListener('click', (e) => {
            if (e.target.id === 'userModal') {
                closeModal();
            }
        });
        
        // ユーザーフォーム送信
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const userData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    department: document.getElementById('department').value,
                    role: document.getElementById('role').value
                };
                
                const password = document.getElementById('password').value;
                if (password) {
                    userData.password = password;
                }
                
                if (isEditMode) {
                    const userId = document.getElementById('userId').value;
                    await UserAPI.update(userId, userData);
                    showAlert('ユーザー情報を更新しました', 'success');
                } else {
                    if (!password) {
                        showAlert('パスワードを入力してください', 'error');
                        return;
                    }
                    await UserAPI.create(userData);
                    showAlert('ユーザーを作成しました', 'success');
                }
                
                closeModal();
                loadUsers();
            } catch (error) {
                handleError(error);
            }
        });
        
        // ユーザー削除
        async function deleteUser(userId) {
            if (!confirm('本当に削除しますか?')) return;
            
            try {
                await UserAPI.delete(userId);
                showAlert('ユーザーを削除しました', 'success');
                loadUsers();
            } catch (error) {
                handleError(error);
            }
        }
        
        // ユーティリティ関数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }
        
        // イベントリスナー
        document.getElementById('searchBtn').addEventListener('click', () => {
            currentPage = 1;
            loadUsers();
        });
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                loadUsers();
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await AuthAPI.logout();
                window.location.href = '/manual_factory/login.html';
            } catch (error) {
                handleError(error);
            }
        });
        
        // 初期化実行
        init();
    </script>
</body>
</html>
