<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手順書一覧 - 手順書管理システム</title>
    <link rel="stylesheet" href="./static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>手順書管理システム</h1>
            <nav id="nav">
                <a href="./index.html">手順書一覧</a>
                <a href="./manuals/create.html" class="btn btn-success">新規作成</a>
                <a href="./users/index.html" id="usersLink" style="display: none;">ユーザー管理</a>
                <span id="userName"></span>
                <button id="logoutBtn">ログアウト</button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title">手順書一覧</h2>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="検索...">
                <select id="statusFilter">
                    <option value="">全て</option>
                    <option value="1">公開</option>
                    <option value="0">下書き</option>
                </select>
                <button class="btn btn-primary" id="searchBtn">検索</button>
            </div>
            
            <div id="manualsContainer">
                <div class="loading">読み込み中</div>
            </div>
            
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
    
    <script src="./static/js/api.js"></script>
    <script>
        let currentUser = null;
        let currentPage = 1;
        const limit = 20;
        
        // 初期化
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            
            // 管理者の場合はユーザー管理リンクを表示
            if (currentUser.role === 'admin') {
                document.getElementById('usersLink').style.display = 'block';
            }
            
            loadManuals();
        }
        
        // 手順書一覧を読み込み
        async function loadManuals() {
            try {
                const search = document.getElementById('searchInput').value;
                const isPublished = document.getElementById('statusFilter').value;
                
                const params = {
                    page: currentPage,
                    limit: limit,
                    search: search,
                    is_published: isPublished
                };
                
                const data = await ManualAPI.list(params);
                
                displayManuals(data.manuals);
                displayPagination(data.pagination);
            } catch (error) {
                handleError(error);
            }
        }
        
        // 手順書を表示
        function displayManuals(manuals) {
            const container = document.getElementById('manualsContainer');
            
            if (manuals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">手順書が見つかりません</p>';
                return;
            }
            
            let html = '<table><thead><tr>';
            html += '<th>タイトル</th>';
            html += '<th>作成者</th>';
            html += '<th>ステップ数</th>';
            html += '<th>状態</th>';
            html += '<th>更新日時</th>';
            html += '<th>操作</th>';
            html += '</tr></thead><tbody>';
            
            manuals.forEach(manual => {
                html += '<tr>';
                html += `<td><a href="./manuals/view.html?id=${manual.id}">${escapeHtml(manual.title)}</a></td>`;
                html += `<td>${escapeHtml(manual.author_name)}</td>`;
                html += `<td>${manual.step_count}</td>`;
                html += `<td>${manual.is_published ? '<span class="badge badge-success">公開</span>' : '<span class="badge badge-warning">下書き</span>'}</td>`;
                html += `<td>${formatDate(manual.updated_at)}</td>`;
                html += '<td>';
                
                // 作成者または管理者のみ編集・削除可能
                if (manual.author_id === currentUser.id || currentUser.role === 'admin') {
                    html += `<a href="./manuals/edit.html?id=${manual.id}" class="btn btn-secondary" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">編集</a>`;
                    html += `<button onclick="deleteManual(${manual.id})" class="btn btn-danger" style="padding: 0.5rem 1rem;">削除</button>`;
                }
                
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ページネーション表示
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 前へボタン
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">前へ</button>`;
            
            // ページ番号
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }
            
            // 次へボタン
            html += `<button ${currentPage === pagination.pages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">次へ</button>`;
            
            container.innerHTML = html;
        }
        
        // ページ変更
        function changePage(page) {
            currentPage = page;
            loadManuals();
        }
        
        // 手順書削除
        async function deleteManual(manualId) {
            if (!confirm('本当に削除しますか?')) return;
            
            try {
                await ManualAPI.delete(manualId);
                showAlert('手順書を削除しました', 'success');
                loadManuals();
            } catch (error) {
                handleError(error);
            }
        }
        
        // ユーティリティ関数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }
        
        // イベントリスナー
        document.getElementById('searchBtn').addEventListener('click', () => {
            currentPage = 1;
            loadManuals();
        });
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                loadManuals();
            }
        });
        
        document.getElementById('statusFilter').addEventListener('change', () => {
            currentPage = 1;
            loadManuals();
        });
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await AuthAPI.logout();
                window.location.href = './login.html';
            } catch (error) {
                handleError(error);
            }
        });
        
        // 初期化実行
        init();
    </script>
</body>
</html>
